<!DOCTYPE html>
<html>
  <head>
    <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
  </head>
<body>
<div style="float:left; width:20%;">
    <a href="http://stormrider.io/maas-rad.html">RAD index</a>
<h3>
<a href="maas-documentation-25.html">Introduction
</a>
</h3>
<ul>
<li>
<a href="about-maas-840.html">About MAAS
</a>
</li>
<li>
<a href="give-me-an-example-of-maas-1314.html">&ldquo;Give me an example&rdquo;
</a>
</li>
<li>
<a href="explore-maas-787.html">Explore MAAS
</a>
</li>
<li>
<a href="whats-new-in-maas-2-8-1655.html">What&rsquo;s new in 2.8
</a>
</li>
<li>
<a href="https://maas.io/install">Quick start
</a>
</li>
</ul>
<h3>Installing MAAS
</h3>
<ul>
<li>
<a href="maas-requirements-789.html">Requirements
</a>
</li>
<li>
<a href="maas-installation-from-a-snap-773.html">Installation
</a>
</li>
<li>
<a href="configuration-journey-781.html">Configuration journey
</a>
</li>
<li>
<a href="installation-and-configuration-checklist-750.html">Setup checklist
</a>
</li>
</ul>
<h3>
  <a href="introduction-to-controllers-786.html">Controllers
  </a>
</h3>
<ul>
  <li>
    <a href="maas-communication-783.html">Communication
    </a>
  </li>
  <li>
    <a href="rack-controllers-771.html">Rack controllers
    </a>
  </li>
  <li>
    <a href="region-controllers-772.html">Region controllers
    </a>
  </li>
  <li>
    <a href="high-availability-804.html">High availability
    </a>
  </li>
</ul>
<h3>
  <a href="introduction-to-machines-829.html">Machines
  </a>
</h3>
<ul>
  <li>
    <a href="add-machines-821.html">Add machines
    </a>
  </li>
  <li>
    <a href="power-management-830.html">Power management
    </a>
  </li>
  <li>
    <a href="commission-machines-822.html">Commission machines
    </a>
  </li>
  <li>Testing
  </li>
  <li>
    <a href="hardware-testing-826.html">Hardware testing
    </a>
  </li>
  <li>
    <a href="network-testing-1267.html">Network testing
    </a>
  </li>
  <li>
    <a href="commissioning-and-hardware-testing-scripts-833.html">Commissioning and hardware testing scripts
    </a>
  </li>
  <li>
    <a href="deploy-machines-825.html">Deploy machines
    </a>
  </li>
  <li>
    <a href="maas-tags-834.html">Tags
    </a>
  </li>
  <li>
    <a href="custom-machine-setup-824.html">Custom machine setup
    </a>
  </li>
  <li>
    <a href="kernel-boot-options-827.html">Kernel boot options
    </a>
  </li>
  <li>
    <a href="resource-pools-831.html">Resource pools
    </a>
  </li>
  <li>
    <a href="storage-775.html">Storage
    </a>
  </li>
  <li>
    <a href="vmware-vmfs-datastores-780.html">VMware VMFS datastores
    </a>
  </li>
  <li>
    <a href="ubuntu-kernels-828.html">Ubuntu kernels
    </a>
  </li>
</ul>
<h3>
  <a href="images-754.html">Images
  </a>
</h3>
<ul>
  <li>
    <a href="select-and-import-images-751.html">Select and import images
    </a>
  </li>
  <li>
    <a href="local-image-mirror-752.html">Local image mirror
    </a>
  </li>
  <li>
    <a href="vmware-images-753.html">VMWare images
    </a>
  </li>
</ul>
<h3>
  <a href="networking-768.html">Networking
  </a>
</h3>
<ul>
  <li>
    <a href="subnet-management-766.html">Subnet management
    </a>
  </li>
  <li>
    <a href="managing-dhcp-759.html">DHCP
    </a>
  </li>
  <li>
    <a href="ip-ranges-760.html">IP ranges
    </a>
  </li>
  <li>
    <a href="proxy-763.html">Proxy
    </a>
  </li>
  <li>
    <a href="ntp-services-762.html">NTP
    </a>
  </li>
  <li>
    <a href="network-discovery-758.html">Network discovery
    </a>
  </li>
  <li>
    <a href="ipv6-addressing-761.html">IPv6
    </a>
  </li>
  <li>
    <a href="configuring-tls-encryption-764.html">SSL
    </a>
  </li>
  <li>
    <a href="managing-stp-765.html">STP
    </a>
  </li>
  <li>
    <a href="availability-zones-820.html">Availability zones (AZs)
    </a>
  </li>
</ul>
<h3>
  <a href="introduction-to-vm-hosting-1524.html">VM hosting
  </a>
</h3>
<ul>
  <li>
    <a href="vm-host-networking-1526.html">VM host networking
    </a>
  </li>
  <li>
    <a href="adding-a-vm-host-1549.html">Add a VM host
    </a>
  </li>
  <li>
    <a href="vm-host-storage-pools-1525.html">VM host storage pools
    </a>
  </li>
  <li>
    <a href="creating-and-deleting-vms-806.html">Creating and deleting VMs
    </a>
  </li>
</ul>
<h3>Operations
</h3>
<ul>
  <li>
    <a href="prometheus-metrics-813.html">Prometheus metrics
    </a>
  </li>
  <li>
    <a href="backup-792.html">Backup
    </a>
  </li>
  <li>
    <a href="hardening-your-maas-installation-1381.html">MAAS security
    </a>
  </li>
  <li>
    <a href="maas-logging-1468.html">Logging
    </a>
  </li>
  <li>
    <a href="commissioning-logs-1478.html">Commissioning logs
    </a>
  </li>
  <li>
    <a href="user-accounts-790.html">User accounts
    </a>
  </li>
  <li>
    <a href="interactive-search-819.html">Interactive search
    </a>
  </li>
</ul>
<h3>
  <a href="concepts-and-terms-785.html">Concepts &amp; terms
  </a>
</h3>
<ul>
  <li>
    <a href="concepts-and-terms-785.html#heading--network-tutorial">Brief network tutorial
    </a>
  </li>
</ul>
<h3>
  <a href="maas-cli-802.html">CLI
  </a>
</h3>
<ul>
  <li>
    <a href="common-cli-tasks-794.html">Common tasks
    </a>
  </li>
  <li>
    <a href="audit-event-logs-791.html">Audit event logs
    </a>
  </li>
  <li>
    <a href="cli-kernel-management-799.html">Kernel management
    </a>
  </li>
  <li>
    <a href="cli-image-management-797.html">Image management
    </a>
  </li>
  <li>
    <a href="cli-interface-management-798.html">Interface management
    </a>
  </li>
  <li>
    <a href="cli-tag-management-801.html">Tag management
    </a>
  </li>
  <li>
    <a href="cli-resource-pool-management-800.html">Resource pool management
    </a>
  </li>
  <li>
    <a href="cli-dhcp-snippet-management-796.html">DHCP snippet management
    </a>
  </li>
  <li>
    <a href="cli-commissioning-and-hardware-testing-scripts-832.html">Commissioning and hardware testing scripts
    </a>
  </li>
  <li>
    <a href="cli-advanced-tasks-793.html">Advanced tasks
    </a>
  </li>
  <li>
    <a href="cli-composable-hardware-795.html">Composable hardware
    </a>
  </li>
  <li>
    <a href="python-api-client-810.html">API client
    </a>
  </li>
</ul>
<h3>
  <a href="https://maas.io/docs/api">API documentation
  </a>
</h3>
<ul>
  <li>
    <a href="api-authentication-742.html">API authentication
    </a>
  </li>
</ul>
<h3>
  <a href="troubleshooting-837.html">Troubleshoot
  </a>
</h3>
<ul>
  <li>
    <a href="getting-help-838.html">Getting help
    </a>
  </li>
  <li>
    <a href="tips-tricks-and-traps-1506.html">Tips, tricks, and traps
    </a>
  </li>
  <li>
    <a href="https://old-docs.maas.io/2.5/en/">MAAS 2.5 (+ earlier) doc
    </a>
  </li>
</ul>
<h3>
  <a href="whats-new-in-maas-2-8-1655.html">Release notes
  </a>
</h3>
<h3>
  <a href="writing-guide-747.html">Help improve these docs
  </a>
</h3>
    </div>
<div class="container" style="float:right; width:75%;">
<h1>Add a VM host</h1><p>[note type=&rdquo;warning&rdquo; status=&rdquo;Deprecated page&rdquo;]
This page has been deprecated in favor of newer terminology and technology.  Please see the <a href="adding-a-vm-host-1549.html">updated page</a>.
</blockquote></p>
<p>After installing MAAS, the &lsquo;KVM&rsquo; page is typically empty:</p>
<p><img alt="kvm-open-screen|638x321" src="upload://zG2Jg6P7iEbakdEQtGVzm5WcY9l.jpeg"> </p>
<h2 id="heading--25">2.5+</h2>

<p>Once MAAS has enlisted, commissioned, and acquired a newly-added machine, you can deploy it as a KVM host:</p>
<p><img alt="kvmpoddeploy" src="//discourse.maas.io/uploads/default/original/1X/63904b128941348ac07ec6a40ee12c51748c9f0a.png"></p>
<h3 id="heading--cli">CLI</h3>

<p>Once MAAS has enlisted, commissioned, and acquired a machine, you can deploy it as a KVM host:</p>
<pre><code class="bash">maas $PROFILE machine deploy &lt;system_id&gt; install_kvm=True
</code></pre>

<h2 id="heading--manualpre-25">Manual/Pre-2.5</h2>

<p>Setting up a manual KVM host in 2.5 or on an older version of MAAS requires more steps.</p>
<h3 id="heading--set-up-a-maas-libvirt-network">Set up a `maas` libvirt network</h3>

<p>Libvirt by default creates a virtual bridge, <code>virbr0</code>, through which VMs communicate with each other and the Internet. DHCP, supplied by libvirt, automatically assigns an IP address to each VM.  However, to enable network booting in MAAS, you’ll need to provide DHCP in MAAS and either:</p>
<ol>
<li>Disable DHCP on libvirt’s <code>default</code> network, or</li>
<li>Create a new libvirt network <code>maas</code> with DHCP disabled.</li>
</ol>
<p>You can set up such a <code>maas</code> network like this:</p>
<pre><code class="bash">cat &lt;&lt; EOF &gt; maas.xml
&lt;network&gt;
 &lt;name&gt;maas&lt;/name&gt;
 &lt;forward mode='nat'&gt;
   &lt;nat&gt;
     &lt;port start='1024' end='65535'/&gt;
   &lt;/nat&gt;
 &lt;/forward&gt;
 &lt;dns enable=&quot;no&quot; /&gt;
 &lt;bridge name='virbr1' stp='off' delay='0'/&gt;
 &lt;domain name='testnet'/&gt;
 &lt;ip address='172.16.99.1' netmask='255.255.255.0'&gt;
 &lt;/ip&gt;
&lt;/network&gt;
EOF
virsh net-define maas.xml
</code></pre>

<p>Note that this network also has NAT port forwarding enabled to allow VMs to communicate with the Internet at large. Port forwarding is very useful in test environments.</p>
<h3 id="heading--set-up-ssh">Set up SSH</h3>

<p>For MAAS to successfully communicate with libvirt on your KVM host machine, this example command must succeed from every rack controller as user <code>maas</code>:</p>
<pre><code class="bash">virsh -c qemu+ssh://$USER@$KVM_HOST_IP/system list --all
</code></pre>

<p>Here, <code>$USER</code> is a user on your KVM host who is a member of the <code>libvirtd</code> Unix group on the KVM host, and <code>$KVM_HOST_IP</code> is the IP of your KVM host.</p>
<p><blockquote style="background:lightgrey;">
It&rsquo;s essential to enforce usage of IP addresses to avoid domain name conflicts, should different controllers resolve the same domain name with different IP addresses. You should also avoid using 127.0.0.1 when running multiple controllers, as it would confuse MAAS.
</blockquote></p>
<h4>MAAS package installs</h4>

<p>The <code>maas</code> user on your rack controllers will issue all virsh commands. Therefore, you&rsquo;ll need to set up SSH public keys on every rack controller for user <code>maas</code>.</p>
<p>If you installed MAAS via packages, first create SSH keys on all rack controllers:</p>
<pre><code class="bash">sudo chsh -s /bin/bash maas
sudo su - maas
ssh-keygen -t rsa -N ''
</code></pre>

<p>Next, add the contents of <code>~maas/.ssh/id_rsa.pub</code> to the KVM host user&rsquo;s <code>~$USER/.ssh/authorized_keys</code>. To accomplish this, log into your KVM host node, via SSH, from a host for which MAAS has a matching public SSH key.</p>
<h4> MAAS snap installs</h4>

<p>If you installed MAAS via snap, then create the needed SSH keys this way:</p>
<pre><code class="bash">sudo mkdir -p /var/snap/maas/current/root/.ssh
cd /var/snap/maas/current/root/.ssh
sudo ssh-keygen -f id_rsa
</code></pre>

<p>Finally, you&rsquo;ll need to add <code>id_rsa.pub</code> to the <code>authorized_keys</code> file in <code>/home/&lt;kvm-host-user-homedir-name&gt;/.ssh/</code>,  where <code>&lt;kvm-host-user-homedir-name&gt;</code> is the name of your KVM host user.</p>
<p><blockquote style="background:lightgrey;">
Insufficient permissions for <code>$USER</code> may cause the <code>virsh</code> command to fail with an error such as <code>failed to connect to the hypervisor</code>. Check the <code>$USER</code> group membership to make sure <code>$USER</code> is a member of the <code>libvirtd</code> group.
</blockquote></p>
<h3 id="heading--add">Add</h3>

<p>Now, add a KVM host by using the &lsquo;Add pod&rsquo; button. Choose &lsquo;Virsh (Virtual systems)&rsquo; from the &lsquo;Pod type&rsquo; drop-down menu.</p>
<p><img alt="kvm-add-screen|690x250" src="upload://1mHQflonvsii29tTSWDv4vUqzzC.jpeg"> </p>
<p>Here, &lsquo;Virsh address&rsquo; typically looks like the following:</p>
<pre><code class="no-highlight">qemu+ssh://&lt;kvm host IP&gt;/system
</code></pre>

<p><blockquote style="background:lightgrey;">
MAAS will automatically discover and store the resources your KVM host contains. Any existing machines will also appear on the &lsquo;Machines&rsquo; page, and MAAS will automatically attempt to commission them.
</blockquote></p>
<h4 id="heading--add-with-cli">Add with CLI</h4>

<p>Create a KVM host:</p>
<pre><code class="bash">maas $PROFILE pods create type=virsh power_address=qemu+ssh://ubuntu@192.168.1.2/system
</code></pre>

<p>Create a KVM host with <a href="#heading--overcommit-resources">overcommitted resources</a>:</p>
<pre><code class="bash">maas $PROFILE pods create type=virsh power_address=qemu+ssh://ubuntu@192.168.1.2/system \
        power_pass=example cpu_over_commit_ratio=0.3 memory_over_commit_ratio=4.6
</code></pre>

<p>Create a KVM host that uses a default <a href="vm-host-storage-pools-1525.html">storage pool</a>:</p>
<pre><code class="bash">maas $PROFILE pods create type=virsh power_address=qemu+ssh://ubuntu@192.168.1.2/system \
        power_pass=example default_storage_pool=pool1
</code></pre>

<h2 id="heading--configuration">Configuration</h2>

<p>KVM hosts have several configuration options. Modify these by selecting the &lsquo;Configuration&rsquo; tab and clicking &lsquo;Edit&rsquo;. Options include a KVM host&rsquo;s location, password, network zone, and default resource pool.</p>
<p><img alt="pod configuration" src="https://discourse.maas.io/uploads/default/original/1X/e6f9b3effcc9e4f44a09836cf6185449410bae7f.png"></p>
<h3 id="heading--overcommit-resources">Overcommit resources</h3>

<p>Overcommitted resources are those allocated beyond what&rsquo;s available in the physical resource. Using sliders on the configuration page, you can limit whether MAAS will attempt to overcommit CPU and memory. The input fields to the right of the sliders accept floating-point values from 0 to 10, with a default value of 1.</p>
<p>The following shows theoretical examples of these ratios and how they affect physical resource allocation:</p>
<ul>
<li><code>8 physical CPU cores  * 1 multiplier     = 8 virtual CPU cores</code></li>
<li><code>8 physical CPU cores  * 0.5 multiplier   = 4 virtual CPU cores</code></li>
<li><code>32 physical CPU cores * 10.0 multiplier  = 320 virtual CPU cores</code></li>
<li><code>128GB physical memory  * 5.5 multiplier  = 704G virtual Memory</code></li>
</ul>
<p>Overcommitting resources allows a user to compose many MAAS-managed machines without worrying about the physical limitations of the host. For example, on a physical host with four cores and 12 GB of memory, you could compose four virsh machines, each using two cores and 4 GB of memory.  This arrangement overcommits the available physical resources. Provided you never run all four simultaneously, you&rsquo;d have all the benefits of MAAS-managed VMs without over-taxing your host.</p>
<!-- LINKS -->
</div>
</body>
</html>